// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Currency {
  USD
  EUR
  UAH
  RUB
  IRR
}

enum DeliveryType {
  AUTO_KEY
  MANUAL
}

enum ProductStatus {
  draft
  active
  inactive
}

enum Region {
  EU
  US
  TR
  GLOBAL
}

enum OfferStatus {
  draft
  active
  inactive
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())
}

model Category {
  id        String     @id @default(uuid())
  parentId  String?    @map("parent_id")
  name      String
  slug      String
  isActive  Boolean    @default(true) @map("is_active")
  sortOrder Int        @default(0) @map("sort_order")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  // Self-reference for parent-child relationship
  parent   Category?        @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[]       @relation("CategoryHierarchy")
  products Product[]        // Legacy - keep for backward compatibility
  catalogProducts CatalogProduct[]

  // Constraints
  @@unique([slug, parentId], name: "unique_slug_per_level")
  @@index([parentId])
  @@index([isActive])
  @@index([sortOrder])
  @@index([isActive, parentId])
  @@map("categories")
}

// Marketplace catalog: Admin-managed product pages
model CatalogProduct {
  id          String   @id @default(uuid())
  categoryId  String   @map("category_id") // Must be child category
  name        String
  slug        String
  description String?  @db.Text
  imageUrl    String?  @map("image_url")
  isActive    Boolean  @default(true) @map("is_active")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  category Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  variants CatalogVariant[]

  @@unique([categoryId, slug])
  @@index([categoryId, isActive])
  @@index([isActive])
  @@map("catalog_products")
}

// Variants: region/duration/edition combinations
model CatalogVariant {
  id               String   @id @default(uuid())
  productId        String   @map("product_id")
  region           Region
  durationDays     Int?     @map("duration_days")
  edition          String?  // e.g., "Standard", "Deluxe", etc.
  sku              String   @unique
  supportsAutoKey  Boolean  @default(false) @map("supports_auto_key") // Can be delivered via automated key
  supportsManual   Boolean  @default(true) @map("supports_manual")    // Can be delivered manually
  isActive         Boolean  @default(true) @map("is_active")
  sortOrder        Int      @default(0) @map("sort_order")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  product CatalogProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  offers  Offer[]

  @@unique([productId, region, durationDays, edition])
  @@index([productId, isActive])
  @@index([isActive])
  @@map("catalog_variants")
}

// Seller listings for catalog variants
model Offer {
  id                   String       @id @default(uuid())
  sellerId             String       @map("seller_id") // Future: FK to User
  variantId            String       @map("variant_id")
  status               OfferStatus  @default(draft)
  deliveryType         DeliveryType @map("delivery_type")
  priceAmount          Int          @map("price_amount") // In smallest currency unit (cents)
  currency             Currency
  stockCount           Int?         @map("stock_count") // For MANUAL delivery only; AUTO_KEY uses key pool count
  descriptionMarkdown  String?      @map("description_markdown") @db.Text // Seller-rich description (bold, lists, emojis)
  deliveryInstructions String?      @map("delivery_instructions") @db.Text // Required for MANUAL
  publishedAt          DateTime?    @map("published_at")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  variant CatalogVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  keyPool KeyPool?       // 1:1 for AUTO_KEY offers
  orders  Order[]

  @@index([sellerId, status])
  @@index([variantId])
  @@index([variantId, status])
  @@index([status, publishedAt])
  @@map("offers")
}

// Legacy Product model - keep for backward compatibility during migration
model Product {
  id              String        @id @default(uuid())
  sellerId        String        @map("seller_id")
  status          ProductStatus @default(draft)
  deliveryType    DeliveryType  @map("delivery_type")
  categoryId      String?       @map("category_id")
  title           String?
  description     String?
  priceAmount     Int?          @map("price_amount")
  currency        Currency?
  publishedAt     DateTime?     @map("published_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  category            Category?            @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  autoKeyConfig       ProductAutoKeyConfig?
  manualDeliveryConfig ProductManualDeliveryConfig?

  @@index([sellerId, status])
  @@index([categoryId])
  @@index([status, publishedAt])
  @@map("products")
}

model ProductAutoKeyConfig {
  id              String   @id @default(uuid())
  productId       String   @unique @map("product_id")
  keyPoolId       String?  @map("key_pool_id")
  autoDelivery    Boolean  @default(true) @map("auto_delivery")
  stockAlert      Int?     @map("stock_alert")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_auto_key_configs")
}

model ProductManualDeliveryConfig {
  id                  String   @id @default(uuid())
  productId           String   @unique @map("product_id")
  deliveryInstructions String?  @map("delivery_instructions") @db.Text
  estimatedDeliverySLA Int?     @map("estimated_delivery_sla")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_manual_delivery_configs")
}

// ============================================
// AUTO-KEY DELIVERY SYSTEM
// ============================================

enum KeyStatus {
  AVAILABLE
  RESERVED
  DELIVERED
  INVALID
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLED
  CANCELED
}

// Key Pool - Container for keys belonging to an Offer
// Design decision: KeyPool belongs to Offer (1:1 relationship)
// This is simpler and ensures sellers cannot accidentally share keys across offers
model KeyPool {
  id        String   @id @default(uuid())
  offerId   String   @unique @map("offer_id")
  sellerId  String   @map("seller_id") // Denormalized for faster auth checks
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  keys  Key[]

  @@index([sellerId])
  @@index([offerId, isActive])
  @@map("key_pools")
}

// Key - Individual key/code in a pool
// Security: code is encrypted at rest, codeHash for deduplication without revealing code
model Key {
  id            String    @id @default(uuid())
  poolId        String    @map("pool_id")
  codeEncrypted String    @map("code_encrypted") @db.Text // AES-256-GCM encrypted
  codeHash      String    @unique @map("code_hash") // SHA-256 hash for deduplication
  status        KeyStatus @default(AVAILABLE)
  reservedAt    DateTime? @map("reserved_at")
  deliveredAt   DateTime? @map("delivered_at")
  orderId       String?   @map("order_id") // Ties delivery to specific order
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  pool      KeyPool       @relation(fields: [poolId], references: [id], onDelete: Cascade)
  order     Order?        @relation(fields: [orderId], references: [id], onDelete: SetNull)
  auditLogs KeyAuditLog[]

  @@index([poolId, status]) // Fast lookup of available keys
  @@index([poolId, status, createdAt]) // For paginated listing with filters
  @@index([orderId])
  @@map("keys")
}

// ============================================
// KEY AUDIT LOG - Tracks key management actions
// ============================================

enum KeyAuditAction {
  UPLOAD
  EDIT
  INVALIDATE
  REVEAL
}

// Audit log for key management actions
model KeyAuditLog {
  id        String         @id @default(uuid())
  keyId     String         @map("key_id")
  poolId    String         @map("pool_id")
  sellerId  String         @map("seller_id")
  action    KeyAuditAction
  metadata  Json?          // Additional context (e.g., old hash for EDIT)
  createdAt DateTime       @default(now()) @map("created_at")

  key Key @relation(fields: [keyId], references: [id], onDelete: Cascade)

  @@index([keyId])
  @@index([poolId, createdAt])
  @@index([sellerId, createdAt])
  @@map("key_audit_logs")
}

// Order - MVP minimal for testing fulfillment
model Order {
  id           String      @id @default(uuid())
  buyerId      String      @map("buyer_id") // Future: FK to User
  offerId      String      @map("offer_id")
  status       OrderStatus @default(PENDING)
  priceAmount  Int         @map("price_amount") // Snapshot of offer price at purchase
  currency     Currency
  deliveredKey String?     @map("delivered_key") @db.Text // Decrypted key stored on fulfillment (for buyer retrieval)
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  offer Offer @relation(fields: [offerId], references: [id], onDelete: Restrict)
  keys  Key[] // One key per order for AUTO_KEY delivery

  @@index([buyerId, status])
  @@index([offerId])
  @@index([status])
  @@map("orders")
}

// ============================================
// PLATFORM SETTINGS
// ============================================

// Platform-wide configurable settings (single-row table)
// Enforced as single-row via service logic and seed
model PlatformSettings {
  id             String   @id @default(uuid())
  platformFeeBps Int      @map("platform_fee_bps") // Basis points (300 = 3.00%)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("platform_settings")
}
